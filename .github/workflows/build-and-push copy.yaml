name: Build and Push Artifacts

on:
  workflow_dispatch:
  # push:
  #   tags:
  #     - 'v*-rc*'
  #   branches:
  #     - next

permissions:
  contents: write
  packages: write

env:
  DOMAIN: infra

jobs:
  # ---------------------------------------------------------------------------
  # Determine what triggered us and resolve all config up front.
  #
  # Three possible paths:
  #   1. push to next  (developer commit)   → dev,  tag = next-{sha}
  #   2. release, prerelease=true           → qa,   tag = v0.1.2-rc.10
  #   3. release, prerelease=false          → prod, tag = v0.1.2
  #                                            + housekeeping: update qa & int
  #
  # The push-to-next path must skip commits from mapcolonies[bot]
  # (the empty "Release-As" footer commits from smart-release-please).
  # ---------------------------------------------------------------------------
  determine-config:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'push' && github.actor != 'mapcolonies[bot]')
    outputs:
      should_run:      ${{ steps.config.outputs.should_run }}
      image_tag:       ${{ steps.config.outputs.image_tag }}
      chart_tag:       ${{ steps.config.outputs.chart_tag }}
      environment:     ${{ steps.config.outputs.environment }}
      pr_labels:       ${{ steps.config.outputs.pr_labels }}
      update_paths:    ${{ steps.config.outputs.update_paths }}
      is_stable:       ${{ steps.config.outputs.is_stable }}
    steps:
      - name: Resolve config
        id: config
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG="${{ github.event.release.tag_name }}"
            echo "image_tag=${TAG}"        >> "$GITHUB_OUTPUT"
            echo "chart_tag=${TAG}"        >> "$GITHUB_OUTPUT"
            echo "should_run=true"         >> "$GITHUB_OUTPUT"

            if [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
              # RC release → QA
              echo "environment=qa"                            >> "$GITHUB_OUTPUT"
              echo "pr_labels=qa"                              >> "$GITHUB_OUTPUT"
              echo "update_paths=infra/environments/qa.yaml"   >> "$GITHUB_OUTPUT"
              echo "is_stable=false"                           >> "$GITHUB_OUTPUT"
            else
              # Stable release → prod  (housekeeping handled by separate job)
              echo "environment=prod"                            >> "$GITHUB_OUTPUT"
              echo "pr_labels=prod"                              >> "$GITHUB_OUTPUT"
              echo "update_paths=infra/environments/prod.yaml"   >> "$GITHUB_OUTPUT"
              echo "is_stable=true"                              >> "$GITHUB_OUTPUT"
            fi

          else
            # push to next → dev
            echo "image_tag=next-${{ github.sha }}"                  >> "$GITHUB_OUTPUT"
            echo "chart_tag=0.0.0-next-${{ github.sha }}"            >> "$GITHUB_OUTPUT"
            echo "environment=dev"                                    >> "$GITHUB_OUTPUT"
            echo "pr_labels=dev, auto-merge"                          >> "$GITHUB_OUTPUT"
            echo "update_paths=infra/environments/dev.yaml"           >> "$GITHUB_OUTPUT"
            echo "is_stable=false"                                    >> "$GITHUB_OUTPUT"
            echo "should_run=true"                                    >> "$GITHUB_OUTPUT"
          fi

  # ---------------------------------------------------------------------------
  # Build & push Docker image
  # ---------------------------------------------------------------------------
  # push-docker-image:
  #   runs-on: ubuntu-latest
  #   needs: determine-config
  #   if: needs.determine-config.outputs.should_run == 'true'
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v6

  #     - name: Login to ACR
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ${{ secrets.ACR_URL }}
  #         username: ${{ secrets.ACR_PUSH_USER }}
  #         password: ${{ secrets.ACR_PUSH_TOKEN }}

  #     - name: Build and push
  #       uses: docker/build-push-action@v6
  #       with:
  #         context: .
  #         push: true
  #         tags: ${{ secrets.ACR_URL }}/${{ env.DOMAIN }}/${{ github.event.repository.name }}:${{ needs.determine-config.outputs.image_tag }}

  # ---------------------------------------------------------------------------
  # Build & push Helm chart
  # ---------------------------------------------------------------------------
  # push-helm-package:
  #   runs-on: ubuntu-latest
  #   needs: [determine-config, push-docker-image]
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v6

  #     - name: Setup Helm
  #       uses: azure/setup-helm@v4
  #       with:
  #         version: v3.15.4

  #     - name: Push chart to ACR
  #       uses: appany/helm-oci-chart-releaser@v0.5.0
  #       with:
  #         name: ${{ github.event.repository.name }}
  #         repository: helm/${{ env.DOMAIN }}
  #         tag: ${{ needs.determine-config.outputs.chart_tag }}
  #         path: ./helm
  #         registry: ${{ secrets.ACR_URL }}
  #         registry_username: ${{ secrets.ACR_PUSH_USER }}
  #         registry_password: ${{ secrets.ACR_PUSH_TOKEN }}
  #         update_dependencies: 'true'

  # ---------------------------------------------------------------------------
  # Open the PR in test-site for the target environment.
  #
  #   dev  → auto-merge (labels: "dev, auto-merge")
  #   qa   → manual     (labels: "qa")
  #   prod → manual     (labels: "prod")
  # ---------------------------------------------------------------------------
  update-site-values:
    runs-on: ubuntu-latest
    needs: [determine-config]
    # needs: [determine-config, push-helm-package]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Open / update site-values PR
        uses: MapColonies/shared-workflows/actions/update-chart-version@update-chart-version-v0.1.0
        with:
          tag: ${{ needs.determine-config.outputs.chart_tag }}
          repository: test-site
          github_token: ${{ secrets.GH_PAT }}
          chart: ${{ github.event.repository.name }}
          environment: ${{ needs.determine-config.outputs.environment }}
          pr_labels: ${{ needs.determine-config.outputs.pr_labels }}
          paths: ${{ needs.determine-config.outputs.update_paths }}

  # ---------------------------------------------------------------------------
  # Housekeeping — only on stable release.
  # When v0.1.2 is cut, qa and integration are still pointing at v0.1.2-rc.X.
  # This job auto-updates both to the new stable tag so they stay in sync.
  # ---------------------------------------------------------------------------
  housekeeping-update-qa-and-integration:
    runs-on: ubuntu-latest
    needs: [determine-config, push-helm-package]
    if: needs.determine-config.outputs.is_stable == 'true'
    strategy:
      matrix:
        env_name: [qa, integration]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Update ${{ matrix.env_name }} to stable tag
        uses: MapColonies/shared-workflows/actions/update-chart-version@update-chart-version-v0.1.0
        with:
          tag: ${{ needs.determine-config.outputs.chart_tag }}
          repository: test-site
          github_token: ${{ secrets.GH_PAT }}
          chart: ${{ github.event.repository.name }}
          environment: ${{ matrix.env_name }}
          pr_labels: ${{ matrix.env_name }}, auto-merge
          paths: infra/environments/${{ matrix.env_name }}.yaml
