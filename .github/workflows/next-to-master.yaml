name: RC Release Sync (next → master)

on:
  release:
    types: [published]

concurrency:
  group: rc-release-sync-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-to-master:
    runs-on: ubuntu-latest
    # Only run for RC releases from next branch
    if: contains(github.event.release.tag_name, '-rc.')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: next

      - name: Configure Git Identity
        run: |
          git config user.name "mapcolonies[bot]"
          git config user.email "devops[bot]@mapcolonies.com"

      - name: Fetch All Branches
        run: |
          git fetch origin next
          git fetch origin master
          git fetch origin --tags

      - name: Create and Push Sync Branch
        id: create-branch
        run: |
          # Get version from manifest
          VERSION=$(grep -o '"\.": "[^"]*"' .release-please-manifest.json | cut -d'"' -f4 || echo "unknown")
          BRANCH_NAME="release/sync-next-to-master-${VERSION}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # Create branch from master
          git checkout -b "$BRANCH_NAME" origin/master
          
          # Merge next into the branch, preferring next on conflicts (-X theirs)
          git merge origin/next -X theirs --no-edit -m "chore: sync next to master (RC ${VERSION})"
          
          # Push to remote
          git push origin "$BRANCH_NAME" -f
          echo "✓ Branch created with merged changes: $BRANCH_NAME"

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ steps.create-branch.outputs.branch_name }}';
            const version = '${{ steps.create-branch.outputs.version }}';
            
            try {
              // Check if PR already exists for this branch
              const existingPRs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branchName}`,
                base: 'master',
                state: 'open'
              });
              
              let prNumber;
              
              if (existingPRs.data.length > 0) {
                // Update existing PR
                prNumber = existingPRs.data[0].number;
                console.log(`Updating existing PR #${prNumber}`);
                
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  title: `chore: sync next to master (RC ${version})`,
                  body: `## Automatic RC Release Sync`
