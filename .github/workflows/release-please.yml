name: release-please

on:
  workflow_dispatch:
    

permissions:
  contents: write
  pull-requests: write

jobs:
  # JOB 1: The Guardrail - Only interfere if it's a simple FIX
  force-rc-alignment:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/next'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Correct RC Version
        id: calc
        run: |
          # 1. Find the latest RC tag
          LATEST_TAG=$(git describe --tags --match "v*-rc*" --abbrev=0 2>/dev/null || echo "none")
          
          if [ "$LATEST_TAG" == "none" ]; then
            echo "No RC tag found. Letting Release Please handle initialization."
            exit 0
          fi

          echo "Found latest tag: $LATEST_TAG"

          # 2. Check for FEATURE or BREAKING commits since that tag
          COMMITS=$(git log $LATEST_TAG..HEAD --pretty=format:"%s")
          
          # Grep returns exit code 0 if found, 1 if not. We use '|| true' to prevent script failure.
          HAS_FEAT=$(echo "$COMMITS" | grep -E "^feat" || true)
          HAS_BREAKING=$(echo "$COMMITS" | grep -E "BREAKING CHANGE" || true)

          # 3. CRITICAL DECISION:
          # If we find a Feature or Breaking Change, we EXIT.
          # We let Release Please do its natural job (which is to bump 0.1.2 or 0.2.0)
          if [ -n "$HAS_FEAT" ] || [ -n "$HAS_BREAKING" ]; then
             echo "Feature or Breaking Change detected."
             echo "Exiting script to let Release Please perform standard Minor/Major bump."
             exit 0
          fi

          # 4. If we get here, it means we ONLY have fixes/chores.
          # The native Release Please might be confused by ghost history, so we FORCE the patch RC.
          echo "Detected only FIX commits. Enforcing RC increment."
          
          if [[ $LATEST_TAG =~ v([0-9]+\.[0-9]+\.[0-9]+)-rc\.([0-9]+) ]]; then
            BASE_VERSION=${BASH_REMATCH[1]}
            CURRENT_RC=${BASH_REMATCH[2]}
            
            # Increment the RC number (e.g. rc.1 -> rc.2)
            NEXT_RC=$((CURRENT_RC + 1))
            NEXT_VERSION="${BASE_VERSION}-rc.${NEXT_RC}"
            
            echo "Calculated Target Version: $NEXT_VERSION"
            echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Could not parse tag $LATEST_TAG. Skipping."
          fi

      - name: Inject Release-As Footer
        if: steps.calc.outputs.next_version != ''
        run: |
          TARGET_VER="${{ steps.calc.outputs.next_version }}"
          
          LAST_MSG=$(git log -1 --pretty=%B)
          if [[ "$LAST_MSG" == *"Release-As: $TARGET_VER"* ]]; then
            echo "Footer already present. Skipping."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit --allow-empty -m "chore: enforce correct rc version" -m "Release-As: $TARGET_VER"
          git push origin next

  # JOB 2: Main Release Process
  release-please:
    needs: force-rc-alignment
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Run release-please
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GH_PAT }}
          target-branch: ${{ github.ref_name }}
          config-file: release-please-config.${{ github.ref_name }}.json
